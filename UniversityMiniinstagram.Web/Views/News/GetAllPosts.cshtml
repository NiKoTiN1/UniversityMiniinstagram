@model ICollection<Post>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="centeredSt">
    @foreach (var post in Model)
    {
        <div class="row my-4">
            <div class="flex-lg-grow-1">
                <div class="card rounded-lg border-0 shadow-lg mb-6 lift" style="
                width: 500px;
                height: auto;">
                    <img src="@post.Image.Path" alt="Image" id="Image" class="rounded-top mb-1 mx-auto" style="
                        object-fit: cover;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        max-height: 400px;">
                    <div class="card-body">
                        <input class="form-control mb-2" name="Category" readonly="readonly" value="@post.Image.category">

                        <textarea type="text" name="Description" id="Description" readonly="readonly" style="resize: none;" class="form-control mb-2">@post.Description</textarea>
                        <div class="mt-3 mb-2">
                            <label style="cursor: pointer;">
                                @{
                                    var count = post.Likes.Where(userLike => userLike.UserId == ViewBag.UserId).Count();
                                    if (count != 0)
                                    {
                                        <svg style="display:none;" width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-heart " fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M8 2.748l-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
                                        </svg>
                                        <svg width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-heart-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z" />
                                        </svg>
                                        <a value="1" hidden></a>
                                    }
                                    else
                                    {
                                        <svg id="@post.Id svg" width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-heart" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M8 2.748l-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
                                        </svg>
                                        <svg id="@post.Id svgL" style="display:none;" width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-heart-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z" />
                                        </svg>
                                        <a value="0" hidden></a>
                                    }
                                    <a class="mr-2">@post.Likes.Count</a>
                                }
                                <input type="button" value="@post.Id" hidden="hidden" class="Like">
                            </label>
                            <label style="cursor: pointer;">
                                <svg width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-chat-left" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v11.586l2-2A2 2 0 0 1 4.414 11H14a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                                </svg>
                                <input type="button" value="@post.Id" hidden="hidden" class="Comment">
                                <a value="0" hidden></a>
                                @{
                                    var countComm = post.Id.ToString() + "count";
                                    <a id="@countComm" class="mr-2">@post.Comments.Count</a>
                                }
                            </label>
                        </div>

                        <div id="@post.Id" style="display:none;">
                            <hr align="center" width="auto" size="2" color="#E2E2E2" class="mt-0" />
                            @{
                                var contentId = post.Id.ToString() + "content";
                                ViewBag.contentId = contentId;
                            }
                            <div id="@ViewBag.contentId">
                                @foreach (var comment in post.Comments)
                                {
                                    <div class="media chat-item">
                                        <div class="media-body">
                                            <div class="chat-item-title">
                                                <span class="font-weight-bold" data-filter-by="text">@comment.User.UserName</span>
                                            </div>
                                            <div class="chat-item-body DIV-filter-by-text" data-filter-by="text">
                                                <p>@comment.Text</p>
                                            </div>

                                        </div>
                                    </div>
                                }
                            </div>

                            <div class="chat-module-bottom">
                                <form class="row">
                                    @{
                                        var textId = post.Id.ToString() + "text";
                                        ViewBag.textId = textId;
                                    }
                                    <textarea id="@ViewBag.textId" class="form-control col ml-2" placeholder="Comment..." rows="1" style="resize: none;"></textarea>
                                    <label class="col-0 mx-2" style="cursor: pointer;">
                                        <svg width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-cursor-fill mt-1" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M14.082 2.182a.5.5 0 0 1 .103.557L8.528 15.467a.5.5 0 0 1-.917-.007L5.57 10.694.803 8.652a.5.5 0 0 1-.006-.916l12.728-5.657a.5.5 0 0 1 .556.103z" />
                                        </svg>
                                        <input type="button" value="@post.Id" hidden="hidden" class="SendComment">
                                    </label>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts{
    <script type="text/javascript">

        $('.Like').click(function () {
            var label = $(this).parent();
            var postId = $(this).attr("value");
            var svg = label.children().eq(0);
            var svgL = label.children().eq(1);
            var likesCount = label.children().eq(3);
            var isLiked = label.children().eq(2).attr("value");
            if (isLiked == "1") {
                $.ajax({
                    type: 'DELETE',
                    url: 'removeLike',
                    data: { 'postId': postId },
                    success: function (data) {
                        svgL.hide();
                        svg.show();
                        label.children().eq(2).attr("value", "0");
                        likesCount.text(parseInt(likesCount.text()) - 1);
                    }
                });
            }
            else {
                    $.ajax({
                    type: 'POST',
                    url: 'addLike',
                    data: { 'postId': postId },
                    success: function (data) {
                        svg.hide();
                        svgL.show();
                        label.children().eq(2).attr("value", "1");
                        likesCount.text(parseInt(likesCount.text()) + 1);
                    }
                });

            }
        });

        $('.Comment').click(function () {
            var label = $(this).parent();
            var postId = $(this).attr("value");
            var ComId = '#' + postId;
            var isCommntOpen = label.children().eq(2).attr("value");
            if (isCommntOpen == "1") {
                $(ComId).hide();
                label.children().eq(2).attr("value", "0");
            }
            else {
                $(ComId).show();
                label.children().eq(2).attr("value", "1");
            }

        });

        $('.SendComment').click(function () {
            var div = $(this).parent().parent().children(1);
            var postId = $(this).attr("value");
            var textId = '#' + postId + 'text';
            var text = $(textId).val();
            var countComment = $('#' + postId + 'count');
            $.ajax({
                type: 'POST',
                url: 'addComment',
                data: { 'postId': postId, 'text': text},
                success: function (data) {
                    var commAreaId = '#' + postId + 'content';
                    $(commAreaId).append(data);
                    $(textId).val("");   
                    countComment.text(parseInt(countComment.text()) + 1);
                }
            });
        }); 
    </script>
}
